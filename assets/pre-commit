#!/bin/bash
# GOD Document Auto-Update Hook
# Triggers GOD doc updates when component files change

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}[GOD Hook]${NC} Checking for component changes..."

# Get list of changed files in staging area
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Track which components need GOD doc updates
declare -A COMPONENTS_CHANGED

# Map directories to components
while IFS= read -r file; do
    case "$file" in
        bloodbank/*)
            COMPONENTS_CHANGED[bloodbank]=1
            ;;
        holyfields/*)
            COMPONENTS_CHANGED[holyfields]=1
            ;;
        iMi/*)
            COMPONENTS_CHANGED[iMi]=1
            ;;
        jelmore/*)
            COMPONENTS_CHANGED[jelmore]=1
            ;;
        holocene/*)
            COMPONENTS_CHANGED[holocene]=1
            ;;
        candybar/*)
            COMPONENTS_CHANGED[candybar]=1
            ;;
        HeyMa/*)
            COMPONENTS_CHANGED[HeyMa]=1
            ;;
        theboardroom/*)
            COMPONENTS_CHANGED[theboardroom]=1
            ;;
        docs/domains/*)
            # Domain doc changes should update domain GOD docs
            DOMAIN=$(echo "$file" | cut -d'/' -f3)
            COMPONENTS_CHANGED[domain-$DOMAIN]=1
            ;;
    esac
done <<< "$CHANGED_FILES"

# If no component changes, exit early
if [ ${#COMPONENTS_CHANGED[@]} -eq 0 ]; then
    echo -e "${GREEN}[GOD Hook]${NC} No component changes detected."
    exit 0
fi

# List components that need updates
echo -e "${YELLOW}[GOD Hook]${NC} Components changed:"
for component in "${!COMPONENTS_CHANGED[@]}"; do
    echo "  - $component"
done

# Prompt user to update GOD docs
echo ""
echo -e "${YELLOW}[GOD Hook]${NC} GOD documents may need updating."
echo "Would you like to:"
echo "  [1] Update GOD docs now (recommended)"
echo "  [2] Skip for now (commit with manual update required)"
echo "  [3] Abort commit"
read -p "Choice [1/2/3]: " choice

case $choice in
    1)
        echo -e "${GREEN}[GOD Hook]${NC} Updating GOD documents..."
        # TODO: Call automated GOD doc update workflow
        echo -e "${YELLOW}[GOD Hook]${NC} Manual update required. Run: /bmad-bmm-document-project"
        echo "After updating, stage the GOD docs and re-commit."
        exit 1
        ;;
    2)
        echo -e "${YELLOW}[GOD Hook]${NC} Skipping GOD doc update."
        echo "⚠️  REMINDER: Update GOD docs manually after commit."
        ;;
    3)
        echo -e "${RED}[GOD Hook]${NC} Commit aborted."
        exit 1
        ;;
    *)
        echo -e "${RED}[GOD Hook]${NC} Invalid choice. Aborting."
        exit 1
        ;;
esac

exit 0
