#!/usr/bin/env bash
# GOD doc freshness hook (generic fallback)
# This hook is OSS-safe: no hard-coded component names.
# For a repo-specific generated hook, run: assets/bootstrap-pre-commit

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

array_contains() {
  local needle="$1"
  shift || true
  local item
  for item in "$@"; do
    if [[ "$item" == "$needle" ]]; then
      return 0
    fi
  done
  return 1
}

collect_component_roots() {
  # Convention: component GOD docs live at <component>/GOD.md (repo root level).
  find . -mindepth 2 -maxdepth 2 -type f -name GOD.md 2>/dev/null \
    | sort \
    | while IFS= read -r path; do
        local rel="${path#./}"
        local root="${rel%/GOD.md}"
        case "$root" in
          docs|docs/*) continue ;;
        esac
        printf '%s\n' "$root"
      done
}

match_component() {
  local file="$1"
  local best=""
  local root
  for root in "${COMPONENT_ROOTS[@]}"; do
    if [[ "$file" == "$root" || "$file" == "$root/"* ]]; then
      if [[ -z "$best" || ${#root} -gt ${#best} ]]; then
        best="$root"
      fi
    fi
  done
  printf '%s' "$best"
}

echo -e "${GREEN}[GOD Hook]${NC} Checking staged changes..."

CHANGED_FILES="$(git diff --cached --name-only --diff-filter=ACMR)"
if [[ -z "$CHANGED_FILES" ]]; then
  echo -e "${GREEN}[GOD Hook]${NC} No staged file additions/modifications/renames."
  exit 0
fi

COMPONENT_ROOTS=()
while IFS= read -r root; do
  [[ -n "$root" ]] || continue
  if ! array_contains "$root" "${COMPONENT_ROOTS[@]}"; then
    COMPONENT_ROOTS+=("$root")
  fi
done < <(collect_component_roots)

if [[ ${#COMPONENT_ROOTS[@]} -eq 0 ]]; then
  echo -e "${YELLOW}[GOD Hook]${NC} No component GOD docs found. Skipping freshness check."
  exit 0
fi

SOURCE_CHANGED=()
GOD_CHANGED=()
STALE_DOCS=()

while IFS= read -r file; do
  [[ -n "$file" ]] || continue
  component="$(match_component "$file")"
  [[ -n "$component" ]] || continue

  if [[ "$file" == "$component/GOD.md" ]]; then
    if ! array_contains "$component" "${GOD_CHANGED[@]}"; then
      GOD_CHANGED+=("$component")
    fi
  else
    if ! array_contains "$component" "${SOURCE_CHANGED[@]}"; then
      SOURCE_CHANGED+=("$component")
    fi
  fi
done <<< "$CHANGED_FILES"

for component in "${SOURCE_CHANGED[@]}"; do
  if [[ ! -f "$component/GOD.md" ]]; then
    continue
  fi
  if array_contains "$component" "${GOD_CHANGED[@]}"; then
    continue
  fi

  doc="$component/GOD.md"
  if ! array_contains "$doc" "${STALE_DOCS[@]}"; then
    STALE_DOCS+=("$doc")
  fi
done

if [[ ${#STALE_DOCS[@]} -eq 0 ]]; then
  echo -e "${GREEN}[GOD Hook]${NC} No stale GOD docs detected."
  exit 0
fi

echo -e "${YELLOW}[GOD Hook]${NC} Potentially stale GOD docs:"
for doc in "${STALE_DOCS[@]}"; do
  echo "  - $doc"
done

echo ""
echo -e "${YELLOW}[GOD Hook]${NC} Source files changed without corresponding GOD doc updates."
echo "Choose an option:"
echo "  [1] Update docs now (abort commit)"
echo "  [2] Continue commit anyway"
echo "  [3] Abort commit"
read -r -p "Choice [1/2/3]: " choice

case "$choice" in
  1)
    echo -e "${YELLOW}[GOD Hook]${NC} Commit stopped. Update/stage the listed docs, then re-commit."
    exit 1
    ;;
  2)
    echo -e "${YELLOW}[GOD Hook]${NC} Continuing without GOD doc updates."
    exit 0
    ;;
  3)
    echo -e "${RED}[GOD Hook]${NC} Commit aborted."
    exit 1
    ;;
  *)
    echo -e "${RED}[GOD Hook]${NC} Invalid choice. Commit aborted."
    exit 1
    ;;
esac
